# VP-093: Margin Requirement Calculation

**Category:** Leverage/Perpetuals
**Verification tool:** Kani

## What Can Go Wrong
Initial margin must meet `margin >= position_value / max_leverage`. If the division truncates (10M / 100 = 100K, but should require 100,001 for safety), positions can open with insufficient margin. Maintenance margin must be checked continuously to trigger liquidation.

## Why It Matters
Insufficient initial margin means the protocol takes on more risk than intended. If many positions are slightly under-margined, a market move can cascade into mass liquidations that the insurance fund can't cover.

## Real-World Incident
FTX collapse (Nov 2022) was partly due to insufficient margin requirements and risk management. On Solana, Drift Protocol and Mango Markets have detailed margin frameworks.

## Invariant

### Formal Property
```
initial_margin >= position_notional / max_leverage (ceiling)
maintenance_margin >= position_notional * maintenance_ratio
margin_check uses ceil division for safety
```

### Kani Precondition/Postcondition
```rust
#[kani::proof]
fn verify_margin_requirement() {
    let notional: u64 = kani::any();
    let max_leverage: u8 = kani::any();
    let margin: u64 = kani::any();

    kani::assume!(notional > 0 && max_leverage > 0 && max_leverage <= 100);

    // Ceiling division for safety
    let required = (notional as u128 + max_leverage as u128 - 1) / max_leverage as u128;

    if margin as u128 >= required {
        kani::assert!(margin as u128 * max_leverage as u128 >= notional as u128);
    }
}
```

### Proptest Property
```rust
proptest! {
    #[test]
    fn margin_covers_position(
        notional in 1_000_000u64..1_000_000_000,
        leverage in 2u8..100
    ) {
        let required = margin_required_ceil(notional, leverage);
        prop_assert!(required as u128 * leverage as u128 >= notional as u128);
    }
}
```

### LiteSVM Assertion
```rust
// Try to open position with insufficient margin
let result = open_position(&mut ctx, &user, size, insufficient_margin).await;
assert!(result.is_err(), "opened position with insufficient margin");
```

## Suggested Fix
```rust
pub fn margin_required_ceil(notional: u64, max_leverage: u8) -> u64 {
    ((notional as u128 + max_leverage as u128 - 1) / max_leverage as u128) as u64
}
```
