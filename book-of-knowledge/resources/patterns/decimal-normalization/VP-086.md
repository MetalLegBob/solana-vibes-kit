# VP-086: Decimal Scale Factor Multiplication Overflow

**Category:** Decimal Normalization
**Verification tool:** Kani

## What Can Go Wrong
Scale factors like 10^9 or 10^12 are used as precision multipliers. When multiplied with large token amounts (u64), the intermediate result can overflow u64 (10^9 * 10^10 > u64::MAX). Without u128 widening, the result wraps silently.

## Why It Matters
A wrapped scale factor multiplication produces a tiny number instead of a large one. A collateral worth $10M might be valued at $0.01, triggering immediate liquidation.

## Real-World Incident
No specific public incident documented, but scale factor overflow is a standard audit concern for any protocol using fixed-point arithmetic with PRECISION constants.

## Invariant

### Formal Property
```
amount * PRECISION must fit in u128
For u64 amounts and PRECISION = 10^12: max_amount * 10^12 <= u128::MAX
u64::MAX * 10^12 ≈ 1.84 × 10^31 << u128::MAX ≈ 3.4 × 10^38 ✓
```

### Kani Precondition/Postcondition
```rust
#[kani::proof]
fn verify_scale_factor_fits_u128() {
    let amount: u64 = kani::any();
    let precision: u64 = kani::any();

    kani::assume!(precision <= 1_000_000_000_000); // 10^12

    let result = (amount as u128).checked_mul(precision as u128);
    kani::assert!(result.is_some(), "scale factor overflow in u128");
}
```

### Proptest Property
```rust
proptest! {
    #[test]
    fn scale_never_overflows_u128(amount in 0u64..u64::MAX) {
        let result = (amount as u128).checked_mul(PRECISION);
        prop_assert!(result.is_some(), "overflow at amount {}", amount);
    }
}
```

### LiteSVM Assertion
```rust
let max_amount = u64::MAX;
let scaled = (max_amount as u128).checked_mul(PRECISION);
assert!(scaled.is_some(), "PRECISION too large for u128 with max u64");
```

## Suggested Fix
```rust
const PRECISION: u128 = 1_000_000_000_000; // 10^12

pub fn scale_up(amount: u64) -> u128 {
    // u64::MAX * 10^12 = 1.84 × 10^31 << u128::MAX = 3.4 × 10^38
    // This can NEVER overflow u128
    (amount as u128) * PRECISION
}
```
