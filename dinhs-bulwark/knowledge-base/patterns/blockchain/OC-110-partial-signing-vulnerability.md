# OC-110: Partial Signing Vulnerability

**Category:** Blockchain Interaction
**Severity:** HIGH
**Auditors:** CHAIN-01
**CWE:** CWE-345 (Insufficient Verification of Data Authenticity)
**OWASP:** N/A — Blockchain-specific

## Description

Solana's legacy `Transaction` class has two signing methods: `sign()` and `partialSign()`. Calling `sign()` resets all existing signatures, while `partialSign()` preserves them. This distinction creates a vulnerability in multi-signer workflows where a server partially signs a transaction and sends it to the client for the user's signature.

If the client-side wallet adapter or application code calls `sign()` instead of `partialSign()`, the server's signature is stripped, causing the transaction to fail or — worse — allowing the transaction to be modified and re-signed without the server's authorization. Conversely, if a server-side process calls `sign()` after the user has signed, the user's signature is removed.

This is a well-documented issue in the Solana Stack Exchange. The `VersionedTransaction` class improved this by having only a single `sign()` method that does not reset signatures, but many codebases still use the legacy `Transaction` class. The `@solana/wallet-adapter` library internally uses `partialSign` when adding signers, but custom implementations frequently get this wrong.

## Detection

```
grep -rn "\.sign(" --include="*.ts" --include="*.js" | grep -i "transaction"
grep -rn "partialSign" --include="*.ts" --include="*.js"
grep -rn "serialize.*requireAllSignatures.*false" --include="*.ts" --include="*.js"
grep -rn "verifySignatures.*false" --include="*.ts" --include="*.js"
```

Look for: use of `transaction.sign()` in multi-signer flows, `serialize()` with `requireAllSignatures: false`, server-to-client transaction passing without signature preservation logic.

## Vulnerable Code

```typescript
import { Transaction, Keypair } from "@solana/web3.js";

// VULNERABLE: Server signs, client sign() resets server signature
// Server side:
function serverSign(tx: Transaction, serverKeypair: Keypair): string {
  tx.partialSign(serverKeypair);
  return tx.serialize({ requireAllSignatures: false }).toString("base64");
}

// Client side:
async function clientSign(serializedTx: string, wallet: any) {
  const tx = Transaction.from(Buffer.from(serializedTx, "base64"));
  // BUG: sign() resets all signatures including server's
  tx.sign(wallet.keypair);
  return tx.serialize();
}
```

## Secure Code

```typescript
import { Transaction, Keypair } from "@solana/web3.js";

// SECURE: Use partialSign on client to preserve server signature
// Server side:
function serverSign(tx: Transaction, serverKeypair: Keypair): string {
  tx.partialSign(serverKeypair);
  return tx.serialize({ requireAllSignatures: false }).toString("base64");
}

// Client side — use wallet adapter's signTransaction (uses partialSign internally)
async function clientSign(serializedTx: string, wallet: WalletAdapter) {
  const tx = Transaction.from(Buffer.from(serializedTx, "base64"));
  // wallet-adapter's signTransaction uses partialSign, preserving existing sigs
  const signed = await wallet.signTransaction(tx);
  return signed.serialize();
}

// Or use VersionedTransaction which does not reset signatures
import { VersionedTransaction } from "@solana/web3.js";
async function clientSignVersioned(serializedTx: Uint8Array, wallet: WalletAdapter) {
  const tx = VersionedTransaction.deserialize(serializedTx);
  const signed = await wallet.signTransaction(tx);
  return signed.serialize();
}
```

## Impact

Stripped signatures cause transaction failures, breaking multi-signer workflows. In security-critical scenarios, if the server's signature enforces authorization (e.g., co-signing a withdrawal), losing that signature means the authorization check is bypassed. An attacker who can modify the transaction between server signing and client signing could replace instructions while retaining their own valid signature.

## References

- Solana web3.js source: Transaction.sign() resets signatures vs partialSign()
- Solana Stack Exchange: "signTransaction removes partialSigned signatures"
- @solana/wallet-adapter: internal use of partialSign for signer addition
- VersionedTransaction: improved signing behavior without signature reset
