# EP-111: TOCTOU Simulation Evasion (On-Chain)
**Category:** Client-Side / Timing  **Severity:** CRITICAL  **Solana-Specific:** Yes
**Historical Exploits:** Widespread wallet drainer technique (2024-2025, $500M+ total crypto drainer losses)

**Description:** Malicious program behaves differently during wallet simulation (preview) vs actual on-chain execution. Exploits the time gap between when a wallet simulates a transaction (Time-of-Check) and when it executes on-chain (Time-of-Use). Unlike EP-093 (off-chain TOCTOU), this targets the on-chain simulation/execution divergence.

**Attack Flow:**
1. Attacker deploys program that checks mutable external state (lookup table, PDA data, clock)
2. During simulation: program reads "safe" state → transfers small harmless amount
3. User signs based on simulation preview
4. Between sign and execution: attacker updates the external state
5. During execution: program reads "malicious" state → drains wallet

**Why Solana is vulnerable:** Signing grants ALL programs in the transaction write access to writable accounts. Wallet simulations are point-in-time snapshots.

**Vulnerable Pattern:**
```rust
pub fn process(ctx: Context<Process>) -> Result<()> {
    let config = &ctx.accounts.config;  // Mutable external state!
    if config.mode == Mode::Safe {
        // Simulation sees this: small transfer
        transfer(ctx.accounts.user, ctx.accounts.dest, 1)?;
    } else {
        // Execution hits this: drain everything
        transfer(ctx.accounts.user, ctx.accounts.attacker, user_balance)?;
    }
    Ok(())
}
// Attacker updates config.mode between simulation and execution
```
**Secure Pattern:**
```rust
// Programs should not branch on mutable external state for security-critical logic
// Wallets should use transaction guards or simulation-at-execution services
// Protocols: use immutable config or require user signature on config changes
```
**Detection:** Flag programs that branch on mutable external account data in ways that affect fund flows. Check for clock-gated behavior (`Clock::get()?.slot` used in conditionals). Audit programs that read from updatable lookup tables or config PDAs controlled by third parties. Note: This is primarily a wallet/client concern, but auditors should flag programs designed to exploit this pattern.

**Source:** Blockaid TOCTOU analysis (Sep 2024)
