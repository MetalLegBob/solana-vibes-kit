# VP-054: Bad Debt Boundary

**Category:** Liquidation
**Verification tool:** LiteSVM

## What Can Go Wrong
When a position collateral value drops below outstanding debt, the protocol has bad debt that must be socialized. If the protocol fails to detect this boundary, liquidators seize collateral that does not fully cover debt, leaving a growing deficit.

## Why It Matters
An attacker creates positions near the bad debt boundary, uses oracle manipulation to push them over, extracts remaining collateral through partial liquidation, and leaves permanent bad debt behind.

## Real-World Incident
The Mango Markets exploit (October 2022) resulted in approximately M in bad debt when an attacker manipulated the MNGO token price to borrow against inflated collateral.

## Invariant

### Formal Property
```
forall position:
  if collateral_value(position) < debt_value(position):
    bad_debt_flag(position) = true AND
    bad_debt_amount = debt_value - collateral_value
```

### Kani Precondition/Postcondition
```rust
kani::assume!(collateral_value <= u64::MAX / 2 && debt_value <= u64::MAX / 2);
let is_bad = collateral_value < debt_value;
let shortfall = if is_bad { debt_value - collateral_value } else { 0 };
kani::assert!(!is_bad || shortfall > 0);
kani::assert!(is_bad || collateral_value >= debt_value);
```

### Proptest Property
```rust
proptest! {{
    #[test]
    fn bad_debt_detection(
        collateral in 0u64..=u64::MAX/2, debt in 0u64..=u64::MAX/2
    ) {{
        let r = check_bad_debt(collateral, debt);
        if collateral < debt {{ prop_assert!(r.is_bad_debt && r.shortfall == debt - collateral); }}
        else {{ prop_assert!(!r.is_bad_debt && r.shortfall == 0); }}
    }}
}}
```

### LiteSVM Assertion
```rust
let mut ctx = setup_lending_pool(&mut svm);
deposit_collateral(&mut ctx, user, 1_000_000_000);
borrow(&mut ctx, user, 800_000_000);
set_oracle_price(&mut ctx, original_price * 70 / 100);
liquidate(&mut ctx, liquidator, user);
let pos = get_position(&ctx, user);
assert!(pos.bad_debt_flag);
assert_eq!(pos.bad_debt_amount, 100_000_000);
```

## Suggested Fix
```rust
pub fn check_bad_debt(collateral: u64, debt: u64) -> BadDebtResult {{
    if collateral < debt {{
        BadDebtResult { is_bad_debt: true, shortfall: debt - collateral }
    }} else {{
        BadDebtResult { is_bad_debt: false, shortfall: 0 }
    }}
}}
```
